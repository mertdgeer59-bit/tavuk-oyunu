import firebase_admin
from firebase_admin import credentials, db
import telebot
from telebot import types
import json

# --- 1. AYARLAR ---
# Senin Firebase ve Bot Bilgilerin
FIREBASE_URL = "https://chickenempires-default-rtdb.europe-west1.firebasedatabase.app/"
TOKEN = "8444886109:AAF2I-pnlavZjd0tUoQLiWh9J0f6Simjllg"
MY_ID = "8387023870" # Senin Telegram ID'n

bot = telebot.TeleBot(TOKEN)

# --- 2. FIREBASE BAÄLANTISI ---
try:
    if not firebase_admin._apps:
        cred = credentials.Certificate("serviceAccountKey.json")
        firebase_admin.initialize_app(cred, {'databaseURL': FIREBASE_URL})
    print("âœ… FIREBASE BAÄLANDI!")
except Exception as e:
    print(f"âŒ JSON DOSYASI HATASI: {e}")

# --- 3. KOMUTLAR VE MARKET Ä°ÅLEYÄ°CÄ° ---

# Bot BaÅŸlatÄ±ldÄ±ÄŸÄ±nda
@bot.message_handler(commands=['start'])
def start(message):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    btn = types.KeyboardButton("Market ğŸ’", web_app=types.WebAppInfo(url="https://mertdgeer59-bit.github.io/tavuk-oyunu/"))
    markup.add(btn)
    bot.send_message(message.chat.id, "ğŸ£ Tavuk Ä°mparatorluÄŸu'na HoÅŸ Geldin!\nAlttaki Market butonundan alÄ±ÅŸveriÅŸ yapabilirsin.", reply_markup=markup)

# Mini App'ten (GitHub) gelen veriyi yakala
@bot.message_handler(content_types=['web_app_data'])
def handle_data(message):
    data = json.loads(message.web_app_data.data)
    kullanici = data.get('kullanici')
    paket = data.get('paket')

    # Firebase'e Kaydet
    ref = db.reference('odemeler').push({
        'kullanici': kullanici,
        'paket': paket,
        'durum': 'BEKLEMEDE'
    })

    # Sana Onay Butonu GÃ¶nder
    markup = types.InlineKeyboardMarkup()
    markup.add(
        types.InlineKeyboardButton("âœ… ONAYLA", callback_data=f"onay_{ref.key}_{kullanici}"),
        types.InlineKeyboardButton("âŒ REDDET", callback_data=f"red_{ref.key}_{kullanici}")
    )
    bot.send_message(MY_ID, f"ğŸš¨ YENÄ° SÄ°PARÄ°Å!\nğŸ‘¤ Oyuncu: {kullanici}\nğŸ“¦ Paket: {paket}", reply_markup=markup)

# Onay/Red ButonlarÄ±na BasÄ±lÄ±nca
@bot.callback_query_handler(func=lambda call: True)
def callback_handler(call):
    islem, ref_key, user_name = call.data.split("_")
    
    if islem == "onay":
        db.reference(f'odemeler/{ref_key}').update({'durum': 'ONAYLANDI'})
        bot.edit_message_text(f"âœ… {user_name} adlÄ± oyuncunun Ã¶demesi ONAYLANDI!", call.message.chat.id, call.message.message_id)
    else:
        db.reference(f'odemeler/{ref_key}').update({'durum': 'REDDEDÄ°LDÄ°'})
        bot.edit_message_text(f"âŒ {user_name} adlÄ± oyuncunun Ã¶demesi REDDEDÄ°LDÄ°!", call.message.chat.id, call.message.message_id)

# --- 4. SÄ°STEMÄ° Ã‡ALIÅTIR ---
print("ğŸš€ BOT AKTÄ°F! SipariÅŸler bekleniyor...")
bot.infinity_polling()
